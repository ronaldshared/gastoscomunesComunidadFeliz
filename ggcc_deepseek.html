<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Análisis de Boletas de Gastos Comunes</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        h1, h2, h3 {
            color: var(--secondary-color);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        .card {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .file-input-container {
            margin-bottom: 15px;
        }
        
        .file-name {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--primary-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .summary {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .summary h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .total {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--primary-color);
        }
        
        .hidden {
            display: none;
        }
        
        .file-list {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-status {
            font-weight: bold;
        }
        
        .valid {
            color: var(--success-color);
        }
        
        .invalid {
            color: var(--danger-color);
        }
        
        .date-range-selector {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
        }
        
        .date-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-toggle {
            display: flex;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--primary-color);
        }
        
        .chart-toggle button {
            flex: 1;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chart-toggle button.active {
            background: var(--primary-color);
            color: white;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .date-range-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <h1>Sistema de Análisis de Boletas de Gastos Comunes</h1>
    
    <div class="card">
        <h2>Cargar Boletas</h2>
        
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="upload-tab">Subir Archivos</button>
            <button class="tab-btn" data-tab="csv-tab">Usar Base de Datos CSV</button>
        </div>
        
        <div class="tab-content active" id="upload-tab">
            <p>Seleccione los archivos PDF de las boletas de gastos comunes para analizar:</p>
            
            <div class="file-input-container">
                <input type="file" id="pdfFiles" accept=".pdf" multiple>
                <div class="file-name" id="fileNames"></div>
            </div>
            
            <div class="file-list" id="fileList"></div>
            
            <button id="analyzeBtn" class="btn" disabled>Analizar Boletas</button>
            <button id="addMoreBtn" class="btn" disabled>Agregar Más Archivos</button>
            
            <div id="loadingContainer" class="hidden">
                <div class="spinner"></div>
                <div id="loadingText">Procesando archivos...</div>
            </div>
        </div>
        
        <div class="tab-content" id="csv-tab">
            <p>Seleccione el archivo CSV con los datos históricos:</p>
            
            <div class="file-input-container">
                <input type="file" id="csvFile" accept=".csv">
                <div class="file-name" id="csvFileName"></div>
            </div>
            
            <button id="loadCsvBtn" class="btn" disabled>Cargar Datos</button>
            
            <div id="csvLoadingContainer" class="hidden">
                <div class="spinner"></div>
                <div id="csvLoadingText">Cargando datos del CSV...</div>
            </div>
        </div>
    </div>
    
    <div class="card hidden" id="analysisOptions">
        <h2>Opciones de Análisis</h2>
        
        <div id="singleFileOptions">
            <p>Se ha cargado 1 archivo. ¿Qué desea hacer?</p>
            <button id="analyzeSingleBtn" class="btn">Analizar Individualmente</button>
            <button id="addToCsvBtn" class="btn btn-success">Agregar al CSV</button>
        </div>
        
        <div id="multiFileOptions" class="hidden">
            <p>Se han cargado múltiples archivos. Seleccione el rango de fechas a analizar:</p>
            
            <div class="date-range-selector">
                <div>
                    <label for="startDate">Fecha de Inicio:</label>
                    <input type="month" id="startDate" class="date-input">
                </div>
                <div>
                    <label for="endDate">Fecha de Fin:</label>
                    <input type="month" id="endDate" class="date-input">
                </div>
            </div>
            
            <button id="analyzeRangeBtn" class="btn">Analizar Rango Seleccionado</button>
            <button id="analyzeAllBtn" class="btn">Analizar Todos los Archivos</button>
            <button id="addAllToCsvBtn" class="btn btn-success">Agregar Todos al CSV</button>
        </div>
    </div>
    
    <div class="card hidden" id="resultsContainer">
        <h2>Resultados del Análisis</h2>
        
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="table-tab">Tabla de Datos</button>
            <button class="tab-btn" data-tab="charts-tab">Visualizaciones</button>
            <button class="tab-btn" data-tab="summary-tab">Resumen</button>
        </div>
        
        <div class="tab-content active" id="table-tab">
            <div class="actions">
                <button id="downloadCsv" class="btn">Descargar como CSV</button>
                <div>
                    <button id="filterBtn" class="btn">Filtrar por Categoría</button>
                    <select id="categoryFilter" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="all">Todas las categorías</option>
                        <option value="Gastos Administración">Gastos Administración</option>
                        <option value="Mantención">Mantención</option>
                        <option value="Mejoramientos">Mejoramientos</option>
                        <option value="Remuneraciones">Remuneraciones</option>
                        <option value="Reparación">Reparación</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Servicios Básicos">Servicios Básicos</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Año</th>
                            <th>Mes</th>
                            <th>Categoría</th>
                            <th>Ítem</th>
                            <th>Documento</th>
                            <th>Fecha</th>
                            <th>Monto a Pagar</th>
                            <th>Monto Comunidad</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- Los datos se insertarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="charts-tab">
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Distribución de Gastos por Categoría</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Evolución de Gastos</h3>
                    <div class="chart-toggle">
                        <button class="active" data-type="amount">Monto a Pagar</button>
                        <button data-type="community">Monto Comunidad</button>
                    </div>
                    <canvas id="trendChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Comparativa por Categoría</h3>
                    <canvas id="comparisonChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Distribución Mensual</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="summary-tab">
            <div class="summary">
                <h3>Resumen por Categoría</h3>
                <div id="summaryContent">
                    <!-- El resumen se insertará aquí -->
                </div>
                <div class="total" id="totalAmount">
                    <!-- El total general se insertará aquí -->
                </div>
            </div>
            
            <div class="summary" style="margin-top: 20px; background-color: #e8f4fc; color: #333;">
                <h3>Estadísticas</h3>
                <div id="statsContent">
                    <!-- Las estadísticas se insertarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Variables globales
        let uploadedFiles = [];
        let currentData = [];
        let csvData = [];
        let categoryChart, trendChart, comparisonChart, monthlyChart;
        
        // Elementos del DOM
        const pdfFilesInput = document.getElementById('pdfFiles');
        const fileNamesDisplay = document.getElementById('fileNames');
        const fileListDisplay = document.getElementById('fileList');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const loadingContainer = document.getElementById('loadingContainer');
        const loadingText = document.getElementById('loadingText');
        const analysisOptions = document.getElementById('analysisOptions');
        const singleFileOptions = document.getElementById('singleFileOptions');
        const multiFileOptions = document.getElementById('multiFileOptions');
        const analyzeSingleBtn = document.getElementById('analyzeSingleBtn');
        const addToCsvBtn = document.getElementById('addToCsvBtn');
        const analyzeRangeBtn = document.getElementById('analyzeRangeBtn');
        const analyzeAllBtn = document.getElementById('analyzeAllBtn');
        const addAllToCsvBtn = document.getElementById('addAllToCsvBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsBody = document.getElementById('resultsBody');
        const summaryContent = document.getElementById('summaryContent');
        const totalAmount = document.getElementById('totalAmount');
        const downloadCsvBtn = document.getElementById('downloadCsv');
        const filterBtn = document.getElementById('filterBtn');
        const categoryFilter = document.getElementById('categoryFilter');
        const csvFileInput = document.getElementById('csvFile');
        const csvFileNameDisplay = document.getElementById('csvFileName');
        const loadCsvBtn = document.getElementById('loadCsvBtn');
        const csvLoadingContainer = document.getElementById('csvLoadingContainer');
        const csvLoadingText = document.getElementById('csvLoadingText');
        const statsContent = document.getElementById('statsContent');
        
        // Configurar tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Desactivar todos los tabs
                document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                // Activar el tab seleccionado
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Event listeners
        pdfFilesInput.addEventListener('change', handleFileSelect);
        analyzeBtn.addEventListener('click', showAnalysisOptions);
        addMoreBtn.addEventListener('click', resetFileInput);
        analyzeSingleBtn.addEventListener('click', () => analyzeFiles([uploadedFiles[0]]));
        addToCsvBtn.addEventListener('click', () => addToCsv([uploadedFiles[0]]));
        analyzeRangeBtn.addEventListener('click', analyzeByDateRange);
        analyzeAllBtn.addEventListener('click', () => analyzeFiles(uploadedFiles));
        addAllToCsvBtn.addEventListener('click', () => addToCsv(uploadedFiles));
        downloadCsvBtn.addEventListener('click', downloadResultsAsCsv);
        filterBtn.addEventListener('click', filterTable);
        categoryFilter.addEventListener('change', updateFilter);
        csvFileInput.addEventListener('change', handleCsvFileSelect);
        loadCsvBtn.addEventListener('click', loadCsvData);
        
        // Manejar selección de archivos PDF
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                fileNamesDisplay.textContent = '';
                fileListDisplay.innerHTML = '';
                analyzeBtn.disabled = true;
                addMoreBtn.disabled = true;
                return;
            }
            
            // Validar nombres de archivos
            uploadedFiles = files.map(file => {
                const isValid = validateFileName(file.name);
                return {
                    file,
                    name: file.name,
                    isValid,
                    processed: false
                };
            });
            
            // Mostrar lista de archivos
            updateFileListDisplay();
            
            // Habilitar botones
            analyzeBtn.disabled = false;
            addMoreBtn.disabled = false;
        }
        
        // Validar formato del nombre del archivo
        function validateFileName(filename) {
            const pattern = /^\d{6} Boleta gastos comunes (enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre) - \d{4}\.pdf$/i;
            return pattern.test(filename);
        }
        
        // Actualizar la lista de archivos mostrada
        function updateFileListDisplay() {
            fileListDisplay.innerHTML = '';
            
            uploadedFiles.forEach((fileInfo, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileNameSpan = document.createElement('span');
                fileNameSpan.textContent = fileInfo.name;
                
                const fileStatusSpan = document.createElement('span');
                fileStatusSpan.className = 'file-status';
                fileStatusSpan.textContent = fileInfo.isValid ? 'Válido' : 'Inválido';
                fileStatusSpan.classList.add(fileInfo.isValid ? 'valid' : 'invalid');
                
                fileItem.appendChild(fileNameSpan);
                fileItem.appendChild(fileStatusSpan);
                fileListDisplay.appendChild(fileItem);
            });
        }
        
        // Reiniciar el input de archivos para agregar más
        function resetFileInput() {
            pdfFilesInput.value = '';
            fileNamesDisplay.textContent = `${uploadedFiles.length} archivos seleccionados`;
        }
        
        // Mostrar opciones de análisis según cantidad de archivos
        function showAnalysisOptions() {
            // Filtrar solo archivos válidos
            const validFiles = uploadedFiles.filter(f => f.isValid);
            
            if (validFiles.length === 0) {
                alert('No hay archivos válidos para analizar');
                return;
            }
            
            // Configurar opciones según cantidad de archivos
            if (validFiles.length === 1) {
                singleFileOptions.classList.remove('hidden');
                multiFileOptions.classList.add('hidden');
            } else {
                singleFileOptions.classList.add('hidden');
                multiFileOptions.classList.remove('hidden');
                
                // Configurar rangos de fecha
                const dates = validFiles.map(f => {
                    const year = f.name.substring(0, 4);
                    const month = f.name.substring(4, 6);
                    return `${year}-${month.padStart(2, '0')}`;
                }).sort();
                
                startDateInput.min = dates[0];
                startDateInput.max = dates[dates.length - 1];
                startDateInput.value = dates[0];
                
                endDateInput.min = dates[0];
                endDateInput.max = dates[dates.length - 1];
                endDateInput.value = dates[dates.length - 1];
            }
            
            analysisOptions.classList.remove('hidden');
        }
        
        // Analizar archivos específicos
        function analyzeFiles(filesToAnalyze) {
            // Filtrar solo archivos válidos
            const validFiles = filesToAnalyze.filter(f => f.isValid);
            
            if (validFiles.length === 0) {
                alert('No hay archivos válidos para analizar');
                return;
            }
            
            // Mostrar carga
            loadingContainer.classList.remove('hidden');
            loadingText.textContent = `Procesando ${validFiles.length} archivo(s)...`;
            
            // Simular procesamiento (en un caso real, aquí se enviarían al servidor)
            setTimeout(() => {
                // Datos de ejemplo (simulando el análisis del PDF)
                const analyzedData = validFiles.flatMap(fileInfo => {
                    // Extraer año y mes del nombre del archivo
                    const year = fileInfo.name.substring(0, 4);
                    const month = fileInfo.name.substring(4, 6);
                    
                    // Simular datos basados en el CSV de ejemplo
                    return [
                        {
                            año: year,
                            mes: month,
                            Categoria: "Gastos Administración",
                            Item: "Comunidad Feliz Spa Software plataforma",
                            Documento: "155439",
                            Fecha: "01-04-2025",
                            "Monto a pagar": 1863,
                            "Monto comunidad": 77608
                        },
                        {
                            año: year,
                            mes: month,
                            Categoria: "Gastos Administración",
                            Item: "Servicios De Administración L Plaza Spas",
                            Documento: "4",
                            Fecha: "26-03-2025",
                            "Monto a pagar": 11286,
                            "Monto comunidad": 470250
                        },
                        // ... más datos simulados
                        {
                            año: year,
                            mes: month,
                            Categoria: "Servicios Básicos",
                            Item: "Metrogas S.A. Consumo gas cliente 900194943",
                            Documento: "-",
                            Fecha: "09-04-2025",
                            "Monto a pagar": 10409,
                            "Monto comunidad": 433695
                        }
                    ];
                });
                
                currentData = analyzedData;
                displayResults(analyzedData);
                
                // Ocultar carga
                loadingContainer.classList.add('hidden');
                analysisOptions.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
            }, 1500);
        }
        
        // Analizar por rango de fechas
        function analyzeByDateRange() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            if (!startDate || !endDate || startDate > endDate) {
                alert('Seleccione un rango de fechas válido');
                return;
            }
            
            const filesInRange = uploadedFiles.filter(fileInfo => {
                if (!fileInfo.isValid) return false;
                
                const fileYear = fileInfo.name.substring(0, 4);
                const fileMonth = fileInfo.name.substring(4, 6);
                const fileDate = `${fileYear}-${fileMonth}`;
                
                return fileDate >= startDate && fileDate <= endDate;
            });
            
            if (filesInRange.length === 0) {
                alert('No hay archivos válidos en el rango seleccionado');
                return;
            }
            
            analyzeFiles(filesInRange);
        }
        
        // Agregar datos al CSV
        function addToCsv(filesToAdd) {
            const validFiles = filesToAdd.filter(f => f.isValid);
            
            if (validFiles.length === 0) {
                alert('No hay archivos válidos para agregar');
                return;
            }
            
            loadingContainer.classList.remove('hidden');
            loadingText.textContent = `Agregando ${validFiles.length} archivo(s) al CSV...`;
            
            // Simular procesamiento
            setTimeout(() => {
                // Aquí en un caso real se enviarían los archivos al servidor
                // para procesarlos y agregarlos al CSV
                
                // Simular datos agregados
                const newData = validFiles.flatMap(fileInfo => {
                    const year = fileInfo.name.substring(0, 4);
                    const month = fileInfo.name.substring(4, 6);
                    
                    return [
                        {
                            id: csvData.length + 1,
                            "Nombre del archivo": fileInfo.name,
                            año: year,
                            mes: month,
                            Categoria: "Gastos Administración",
                            Item: "Comunidad Feliz Spa Software plataforma",
                            Documento: "155439",
                            Fecha: "01-04-2025",
                            "Monto a pagar": "$1.863",
                            "Monto comunidad": "$77.608",
                            Valor1: "1863",
                            Valor2: "77608"
                        },
                        // ... más datos simulados
                    ];
                });
                
                // Actualizar CSV (simulado)
                csvData = [...csvData, ...newData];
                
                alert(`${validFiles.length} archivo(s) agregados correctamente al CSV`);
                loadingContainer.classList.add('hidden');
                analysisOptions.classList.add('hidden');
                
                // Opcional: Mostrar los datos actualizados
                if (csvData.length > 0) {
                    currentData = csvData;
                    displayResults(csvData);
                    resultsContainer.classList.remove('hidden');
                }
            }, 1500);
        }
        
        // Mostrar resultados en la tabla
        function displayResults(data) {
            // Limpiar tabla
            resultsBody.innerHTML = '';
            
            // Llenar tabla con los datos
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.año || item.year || '-'}</td>
                    <td>${item.mes || item.month || '-'}</td>
                    <td>${item.Categoria || item.category || '-'}</td>
                    <td>${item.Item || item.item || '-'}</td>
                    <td>${item.Documento || item.docNumber || '-'}</td>
                    <td>${item.Fecha || item.date || '-'}</td>
                    <td>${formatCurrency(item["Monto a pagar"] || item.amount || 0)}</td>
                    <td>${formatCurrency(item["Monto comunidad"] || item.communityAmount || 0)}</td>
                `;
                resultsBody.appendChild(row);
            });
            
            // Generar resumen
            generateSummary(data);
            
            // Generar estadísticas
            generateStats(data);
            
            // Inicializar gráficos
            initCharts(data);
        }
        
        // Formatear moneda
        function formatCurrency(amount) {
            if (typeof amount === 'string') {
                // Si ya está formateado, devolver tal cual
                if (amount.startsWith('$')) return amount;
                
                // Si es un número en string, convertirlo
                amount = parseFloat(amount.replace(/[^0-9.-]+/g, ''));
            }
            
            return '$' + amount.toLocaleString('es-CL');
        }
        
        // Generar resumen por categoría
        function generateSummary(data) {
            const summary = {};
            let total = 0;
            
            data.forEach(item => {
                const category = item.Categoria || item.category;
                const amount = parseFloat(item["Monto comunidad"] || item.communityAmount || 0);
                
                if (!summary[category]) {
                    summary[category] = 0;
                }
                
                summary[category] += amount;
                total += amount;
            });
            
            // Mostrar resumen
            summaryContent.innerHTML = '';
            for (const [category, amount] of Object.entries(summary)) {
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <span>${category}</span>
                    <span>${formatCurrency(amount)}</span>
                `;
                summaryContent.appendChild(summaryItem);
            }
            
            // Mostrar total
            totalAmount.innerHTML = `Total General: ${formatCurrency(total)}`;
        }
        
        // Generar estadísticas
        function generateStats(data) {
            if (data.length === 0) {
                statsContent.innerHTML = '<p>No hay datos suficientes para generar estadísticas</p>';
                return;
            }
            
            // Agrupar por mes y año
            const monthlyData = {};
            const categoryData = {};
            
            data.forEach(item => {
                const year = item.año || item.year;
                const month = item.mes || item.month;
                const category = item.Categoria || item.category;
                const amount = parseFloat(item["Monto comunidad"] || item.communityAmount || 0);
                
                // Datos mensuales
                const monthKey = `${year}-${month.padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = 0;
                }
                monthlyData[monthKey] += amount;
                
                // Datos por categoría
                if (!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += amount;
            });
            
            // Calcular promedios y variaciones
            const months = Object.keys(monthlyData).sort();
            let total = Object.values(monthlyData).reduce((sum, val) => sum + val, 0);
            let avg = total / months.length;
            
            let maxMonth = { month: '', value: 0 };
            let minMonth = { month: '', value: Infinity };
            
            for (const [month, value] of Object.entries(monthlyData)) {
                if (value > maxMonth.value) {
                    maxMonth = { month, value };
                }
                if (value < minMonth.value) {
                    minMonth = { month, value };
                }
            }
            
            // Calcular categorías más significativas
            const categories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
            const topCategories = categories.slice(0, 3);
            
            // Mostrar estadísticas
            statsContent.innerHTML = `
                <div class="summary-item">
                    <span>Período analizado:</span>
                    <span>${months[0]} a ${months[months.length - 1]}</span>
                </div>
                <div class="summary-item">
                    <span>Total de meses:</span>
                    <span>${months.length}</span>
                </div>
                <div class="summary-item">
                    <span>Gasto promedio mensual:</span>
                    <span>${formatCurrency(avg)}</span>
                </div>
                <div class="summary-item">
                    <span>Mes con mayor gasto (${maxMonth.month}):</span>
                    <span>${formatCurrency(maxMonth.value)}</span>
                </div>
                <div class="summary-item">
                    <span>Mes con menor gasto (${minMonth.month}):</span>
                    <span>${formatCurrency(minMonth.value)}</span>
                </div>
                <div class="summary-item">
                    <span>Categorías más significativas:</span>
                    <span></span>
                </div>
                ${topCategories.map(cat => `
                    <div class="summary-item" style="padding-left: 20px;">
                        <span>${cat[0]}:</span>
                        <span>${formatCurrency(cat[1])} (${Math.round(cat[1] / total * 100)}%)</span>
                    </div>
                `).join('')}
            `;
        }
        
        // Inicializar gráficos
        function initCharts(data) {
            // Destruir gráficos existentes
            if (categoryChart) categoryChart.destroy();
            if (trendChart) trendChart.destroy();
            if (comparisonChart) comparisonChart.destroy();
            if (monthlyChart) monthlyChart.destroy();
            
            // Preparar datos para gráficos
            const categories = [...new Set(data.map(item => item.Categoria || item.category))];
            const months = [...new Set(data.map(item => `${item.año || item.year}-${(item.mes || item.month).padStart(2, '0')}`))].sort();
            
            // Datos para gráfico de categorías
            const categoryAmounts = categories.map(cat => 
                data.filter(item => (item.Categoria || item.category) === cat)
                   .reduce((sum, item) => sum + parseFloat(item["Monto comunidad"] || item.communityAmount || 0), 0)
            );
            
            // Datos para gráfico de tendencia
            const monthlyAmounts = months.map(month => 
                data.filter(item => `${item.año || item.year}-${(item.mes || item.month).padStart(2, '0')}` === month)
                   .reduce((sum, item) => sum + parseFloat(item["Monto comunidad"] || item.communityAmount || 0), 0)
            );
            
            // Colores para las categorías
            const backgroundColors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', 
                '#9b59b6', '#1abc9c', '#d35400', '#34495e',
                '#16a085', '#c0392b', '#8e44ad', '#f1c40f'
            ];
            
            // Gráfico circular de categorías
            const ctx1 = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: categoryAmounts,
                        backgroundColor: backgroundColors.slice(0, categories.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de tendencia
            const ctx2 = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monto Comunidad',
                        data: monthlyAmounts,
                        backgroundColor: backgroundColors[0],
                        borderColor: backgroundColors[0],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de comparación por categoría
            const ctx3 = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Monto Comunidad',
                        data: categoryAmounts,
                        backgroundColor: backgroundColors.slice(0, categories.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de distribución mensual
            const ctx4 = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: categories.map((cat, i) => ({
                        label: cat,
                        data: months.map(month => 
                            data.filter(item => 
                                (item.Categoria || item.category) === cat && 
                                `${item.año || item.year}-${(item.mes || item.month).padStart(2, '0')}` === month
                            ).reduce((sum, item) => sum + parseFloat(item["Monto comunidad"] || item.communityAmount || 0), 0)
                        ),
                        backgroundColor: backgroundColors[i],
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            stacked: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Configurar toggle para gráfico de tendencia
            document.querySelectorAll('#trendChart ~ .chart-toggle button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('#trendChart ~ .chart-toggle button.active').classList.remove('active');
                    this.classList.add('active');
                    
                    const type = this.getAttribute('data-type');
                    const newData = months.map(month => 
                        data.filter(item => `${item.año || item.year}-${(item.mes || item.month).padStart(2, '0')}` === month)
                           .reduce((sum, item) => sum + parseFloat(
                               type === 'amount' ? 
                               (item["Monto a pagar"] || item.amount || 0) : 
                               (item["Monto comunidad"] || item.communityAmount || 0)
                           ), 0)
                    );
                    
                    trendChart.data.datasets[0].data = newData;
                    trendChart.data.datasets[0].label = type === 'amount' ? 'Monto a Pagar' : 'Monto Comunidad';
                    trendChart.update();
                });
            });
        }
        
        // Filtrar tabla por categoría
        function filterTable() {
            const selectedCategory = categoryFilter.value;
            const rows = resultsBody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const categoryCell = row.cells[2]; // La celda de categoría es la tercera (índice 2)
                if (selectedCategory === 'all' || categoryCell.textContent === selectedCategory) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        // Actualizar filtro
        function updateFilter() {
            filterTable();
            // También podríamos actualizar los gráficos aquí si queremos
        }
        
        // Descargar resultados como CSV
        function downloadResultsAsCsv() {
            const rows = [];
            const headers = ["Año", "Mes", "Categoría", "Ítem", "Documento", "Fecha", "Monto a Pagar", "Monto Comunidad"];
            rows.push(headers.join(','));
            
            const tableRows = resultsBody.getElementsByTagName('tr');
            for (let row of tableRows) {
                if (row.style.display === 'none') continue;
                
                const cells = row.cells;
                const rowData = [];
                for (let i = 0; i < cells.length; i++) {
                    rowData.push(cells[i].textContent);
                }
                rows.push(rowData.join(','));
            }
            
            const csvContent = rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `analisis_gastos_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Manejar selección de archivo CSV
        function handleCsvFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                csvFileNameDisplay.textContent = file.name;
                loadCsvBtn.disabled = false;
            } else {
                csvFileNameDisplay.textContent = '';
                loadCsvBtn.disabled = true;
            }
        }
        
        // Cargar datos del CSV
        function loadCsvData() {
            const file = csvFileInput.files[0];
            if (!file) {
                alert('Seleccione un archivo CSV primero');
                return;
            }
            
            csvLoadingContainer.classList.remove('hidden');
            csvLoadingText.textContent = 'Cargando datos del CSV...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Parsear CSV
                csvData = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const item = {};
                    headers.forEach((header, i) => {
                        item[header] = values[i] ? values[i].trim() : '';
                    });
                    return item;
                }).filter(item => item.id); // Filtrar líneas vacías
                
                currentData = csvData;
                
                // Mostrar resultados
                displayResults(csvData);
                resultsContainer.classList.remove('hidden');
                csvLoadingContainer.classList.add('hidden');
                
                alert(`Datos cargados correctamente: ${csvData.length} registros`);
            };
            
            reader.onerror = function() {
                alert('Error al leer el archivo CSV');
                csvLoadingContainer.classList.add('hidden');
            };
            
            reader.readAsText(file);
        }
    </script>
</body>
</html>